---
import Search from "astro-pagefind/components/Search"
---

<div
  id="backdrop"
  class="bg-[rgba(0, 0, 0, 0.5] invisible fixed left-0 top-0 z-50 flex h-screen w-full justify-center p-6 backdrop-blur-sm"
>
  <div
    id="pagefind-container"
    class="m-0 flex h-fit max-h-[80%] w-full max-w-screen-sm flex-col overflow-auto rounded border border-border bg-background p-2 px-4 py-3 text-foreground shadow-lg"
  >
    <Search
      id="search"
      className="pagefind-ui"
      uiOptions={{
        showImages: false,
        excerptLength: 15,
        resetStyles: false
      }}
    />
    <div class="mr-2 pb-1 pt-4 text-right text-xs dark:prose-invert">
      Press <span class="prose text-xs dark:prose-invert"
        ><kbd class="">Esc</kbd></span
      > or click anywhere to close
    </div>
  </div>
</div>

<script is:inline>
  const magnifyingGlass = document.getElementById("magnifying-glass")
  const backdrop = document.getElementById("backdrop")

  function openPagefind() {
    const searchDiv = document.getElementById("search")
    const search = searchDiv.querySelector("input")
    setTimeout(() => {
      search.focus()
    }, 0)
    backdrop?.classList.remove("invisible")
    backdrop?.classList.add("visible")
  }

  function closePagefind() {
    const search = document.getElementById("search")
    search.value = ""
    backdrop?.classList.remove("visible")
    backdrop?.classList.add("invisible")
  }

  // open pagefind
  magnifyingGlass?.addEventListener("click", () => {
    openPagefind()
  })

  document.addEventListener("keydown", e => {
    if (e.key === "/") {
      e.preventDefault()
      openPagefind()
    } else if ((e.metaKey || e.ctrlKey) && e.key === "k") {
      e.preventDefault()
      openPagefind()
    }
  })

  // close pagefind
  document.addEventListener("keydown", e => {
    if (e.key === "Escape" || e.keyCode === 27) {
      closePagefind()
    }
  })

  backdrop?.addEventListener("click", event => {
    if (!event.target.closest("#pagefind-container")) {
      closePagefind()
    }
  })

  // prevent form submission
  const form = document.getElementById("form")
  form?.addEventListener("submit", event => {
    event.preventDefault()
  })
</script>
